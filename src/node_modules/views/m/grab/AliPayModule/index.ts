import * as tomato from "@po-to/tomato";
import * as tdom from "@po-to/tomato-jquery";
import * as project from "views/global/common/Project";
import * as funs from "views/global/common/Funs";
import * as model from "views/global/common/Model";
import * as api from "views/global/common/API";
import paydone = require('views/m/grab/PayDoneModal');

class VPresenter extends project.VPresenter {
    private alipay_code: any;
    constructor(view: tomato.VPView, parent?: tomato.VPresenter, vpid?: string) {
        super(view, parent, vpid);
        this._watchEvent();
        // this._els = this._getElements();
    }
    public setCtx = function (chargeBill) {
        this.find('.deposit').text(chargeBill.money);
        //充值时的订单号
        this.alipay_code = chargeBill.alipay_code;
    };
    //抢单页充值时点击
    _evt_doCharge = function () {
        var that = this;
        var alipay_code = that.alipay_code;
        var host = window.location.host;
        var protocol = window.location.protocol;
        var href = window.location.href;
        var transTo = '';
        // 如果是抢单充值
        if (href.indexOf('ChatRoom') > 0) {
            var uid = model.globalData.current_demand.uid;
            //充值成功跳转到transfer页面,通过from参数来判定是来自支付宝跳转
            transTo = protocol + '//' + host + '/chatroom.html?uid=' + uid + '&fromAlipay';

            // 如果是开通短信增值服务充值
        }else if(href.indexOf('ValueAddService') > 0){
             //充值成功跳转到transfer页面,通过from参数来判定是来自支付宝跳转
            transTo = protocol + '//' + host + '/user/ValueAddService?fromAlipay';
        }else{
            // 钱包充值 (支付宝回首页)
            transTo = protocol + '//' + host + '/Index';
        }

        //对url进行encode
        var afterpayto = encodeURIComponent(transTo);
        var url = "`{APIURL}`/Bill/pay?bill_id=" + alipay_code + '&return_url=' + afterpayto;
        window.open(url);

        tomato.getVPresenter<paydone>(funs.moduleToUrl('m/grab/PayDoneModal'), (paydone) => {
            paydone.setCtx(that.alipay_code);
            tdom.open(paydone, tdom.DialogTarget.Self, {
                size: { width: '90%', height: tomato.DialogSize.Content },
                masked: true,
            });
        });
    };

}
export = VPresenter;