import * as tomato from "@po-to/tomato";
import * as tdom from "@po-to/tomato-jquery";
import * as project from "views/global/common/Project";
import * as funs from "views/global/common/Funs";
import * as model from "views/global/common/Model";
import * as api from "views/global/common/API";
import alipay = require('views/m/grab/AliPayModule');
import PayADeposit = require('views/m/grab/PayADepositModal');
import SMSPopup = require('views/m/user/SMSPopup');
import wallet = require('views/m/user/Wallet');

class VPresenter extends project.VPresenter {
    private alipay_code: any;

    constructor(view: tomato.VPView, parent?: tomato.VPresenter, vpid?: string) {
        super(view, parent, vpid);
        this._watchEvent();
        this._els = this._getElements();
    }
    public setCtx = function (alipay_code) {
        //抢单页 参数
        this.alipay_code = alipay_code;
    };
    _evt_payDone = function () {
        this._grab_pay_confirm(false);
    };
    _evt_payFail = function () {
        this._grab_pay_confirm(true);
    };
    //验证是否支付成功
    private _grab_pay_confirm = function (repay) {
        var that = this;
        var demand_id = model.globalData.current_demand.id;
        var href = window.location.href;
        //充值验证
        api.chargeConfirm({ "bill_id": that.alipay_code }, function (json) {
            that.parent.close();
            api.GetUserInfo(function (user) {
                model.globalData.user.balance = user.bal;
                // 如果是抢单充值
                if (href.indexOf('ChatRoom') > 0) {
                    funs.tip('充值完成', '', 'succ');
                    tomato.getVPresenter<PayADeposit>(funs.moduleToUrl('m/grab/PayADepositModal'), (PayADeposit) => {
                        // 如果已经抢过单，则不处理
                        if (model.globalData.current_demand.supplier_partic_status == "10" || model.globalData.current_demand.supplier_partic_status == '200') {
                            return
                        }
                        // 自动触发抢单！
                        tomato.getVPresenter<PayADeposit>(funs.moduleToUrl('m/grab/PayADepositModal'), (PayADeposit) => {
                            PayADeposit._evt_ensure(true);
                        });
                    });

                    // 如果是开通短信增值服务充值
                } else if (href.indexOf('ValueAddService') > 0) {
                    var records = localStorage.getItem('openSmsRecord');
                    if (records) {
                        var recordsArgs = JSON.parse(records);
                        tomato.getVPresenter<SMSPopup>(funs.moduleToUrl('m/user/SMSPopup'), (SMSPopup) => {
                            SMSPopup._evt_ensure(recordsArgs);
                        });
                    }
                    
                    // 钱包充值按钮充值
                } else {
                    tomato.getVPresenter<wallet>(funs.moduleToUrl('m/user/Wallet'), (wallet) => {
                        wallet.init();
                    });
                }

            })
        },
            function (json) {
                if (repay) {
                    //打开“支付宝”弹窗
                    tomato.getVPresenter<alipay>(funs.moduleToUrl('m/grab/AliPayModule'), (alipay) => {
                        // alipay.setCtx(chargeBill);
                        tdom.open(alipay, tdom.DialogTarget.Self, {
                            size: { width: '90%', height: tomato.DialogSize.Content },
                            masked: true,
                        });
                    });
                } else {
                    //打开“未收到款项”弹窗
                    tomato.getVPresenter<tomato.VPresenter>(funs.moduleToUrl('m/grab/GotNoMoneyModal'), (GotNoMoneyModal) => {
                        tdom.open(GotNoMoneyModal, tdom.DialogTarget.Self, {
                            size: { width: '90%', height: tomato.DialogSize.Content },
                            masked: true,
                        });
                    });
                }
            }
        );
    };
}
export = VPresenter;