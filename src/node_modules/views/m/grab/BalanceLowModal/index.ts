import * as tomato from "@po-to/tomato";
import * as tdom from "@po-to/tomato-jquery";
import * as project from "views/global/common/Project";
import * as funs from "views/global/common/Funs";
import * as model from "views/global/common/Model";
import * as api from "views/global/common/API";
import alipay = require('views/m/grab/AliPayModule');

class VPresenter extends project.VPresenter {
    constructor(view: tomato.VPView, parent?: tomato.VPresenter, vpid?: string) {
        super(view, parent, vpid);
        this._watchEvent();
        this._els = this._getElements();
    }
    setChoosedMoney = function(money){
        var sd;
        money = parseInt(money);
        if(money <= 200){
            sd = $('.choose-money>div').eq(0);
        }else if(money>200 && money<=500){
            sd = $('.choose-money>div').eq(1);
        }else if(money>500){
            sd = $('.choose-money>div').eq(2);
        }else{
            return
        }
        sd.addClass('choosed').removeClass('select');
        sd.siblings().removeClass('choosed').addClass('select');
    }
    _evt_chooseMoney = function (data, target, hit) {
        var select = $(hit).parents('.select');
        select.addClass('choosed').removeClass('select');
        select.siblings().removeClass('choosed').addClass('select');
    };
    _evt_payMoney = function () {
        var price = { 'amt': this.find('.choosed span').text() };
        //充值订单请求发送;
        api.chargeOrder(price, function (json) {
            //获取订单号;
            let chargeBill ={
                money: price.amt,
                alipay_code: json.bill.id
            }
            tomato.getVPresenter<alipay>(funs.moduleToUrl('m/grab/AliPayModule'), (alipay) => {
                alipay.setCtx(chargeBill);
                tdom.open(alipay, tdom.DialogTarget.Self, {
                    size: { width: '90%', height: tomato.DialogSize.Content },
                    masked: true,
                });
            });
        }, function (data: tomato.PError) {
            funs.tip('请求失败，请重试',data.note,'fail');
        });
    };
}
export = VPresenter;