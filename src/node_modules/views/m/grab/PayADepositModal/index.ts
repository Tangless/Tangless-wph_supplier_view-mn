import * as tomato from "@po-to/tomato";
import * as tdom from "@po-to/tomato-jquery";
import * as project from "views/global/common/Project";
import * as funs from "views/global/common/Funs";
import * as model from "views/global/common/Model";
import * as api from "views/global/common/API";
import * as Vue from 'vue';
import wallet = require('views/m/user/Wallet');
import balLow = require('views/m/grab/BalanceLowModal');

class VPresenter extends project.VPresenter {
    constructor(view: tomato.VPView, parent?: tomato.VPresenter, vpid?: string) {
        super(view, parent, vpid);
        this._watchEvent();
        this._els = this._getElements();

        var v_pane = this.find('.vue-pane')[0];
        var data = model.globalData;

        new Vue({
            el: v_pane,
            data: data,
        })
    }
    _evt_ensure = function (fromAlipay?: any) {
        var that = this;
        var data = model.globalData;
        var demand_id = model.globalData.current_demand.id;
        //查看余额是否充足
        if (data.user.balance >= data.current_demand.bid_fee) {
            //抢单
            api.grabDemand({ "demand_id": demand_id }, function (json) {
                // 更新项目信息
                var curr_pro = model.globalData.current_demand;
                curr_pro.supplier_partic_status = json.demand_info.supplier_partic_status;
                curr_pro.supplier_list = json.demand_info.partic_supplier_list;
                curr_pro.bid_cnt = json.demand_info.demand.bid_cnt;
                curr_pro.status = json.demand_info.demand.status;
                curr_pro.user.phone = json.demand_info.user.mobile;

                var pro_list = model.globalData.project_list;
                // 更新项目列表中此项目的信息
                for (var i = 0; i < pro_list.length; i++) {
                    if (curr_pro.id == pro_list[i].id) {
                        pro_list[i] = curr_pro;
                        break;
                    }
                }
                // 更新参与项目列表信息
                let joined_list = model.globalData.joined_list;
                let hasPro = false;
                for (var i = 0; i < joined_list.length; i++) {
                    if (curr_pro.id == joined_list[i]) {
                        joined_list[i] = $.extend(joined_list[i], curr_pro);
                        hasPro = true;
                    }
                }
                if (!hasPro) {
                    joined_list.push(curr_pro);
                }
                (that.parent as tomato.Dialog).close();
                funs.tip('支付成功', '点击电话图标，快速联系客户', 'succ');
                // 更新钱包消费记录
                tomato.getVPresenter<wallet>(funs.moduleToUrl('m/user/Wallet'), (wallet) => {
                    wallet.init();
                });
                // 更新钱包余额
                api.GetUserInfo(function (user) {
                    model.globalData.user.balance = user.bal;
                })
            },
                function (data: tomato.PError) {
                    //如果请求失败,刷新当前
                    funs.tip('请求失败，请重试', data.note, 'fail');
                })

        } else {
            //弹出余额不足的弹窗
            tomato.getVPresenter<balLow>(funs.moduleToUrl('m/grab/BalanceLowModal'), (balLow) => {
                var openStyle = tdom.DialogTarget.Self;
                // 如果是支付宝跳转过来的
                if (fromAlipay) {
                    openStyle = tdom.DialogTarget.Blank;
                }
                balLow.setChoosedMoney(data.current_demand.bid_fee);
                tdom.open(balLow, openStyle, {
                    size: { width: '90%', height: tomato.DialogSize.Content },
                    masked: true,
                });
            });
        }
    }
}
export = VPresenter;