import * as tomato from "@po-to/tomato";
import * as tdom from "@po-to/tomato-jquery";
import * as project from "views/global/common/Project";
import * as funs from "views/global/common/Funs";
import * as model from "views/global/common/Model";
import * as api from "views/global/common/API";

class VPresenter extends project.VPresenter {
    private _header: tomato.VPresenter;
    private _loadMore: boolean;
    private _moreLoading: JQuery;

    constructor(view: tomato.VPView, parent?: tomato.VPresenter, vpid?: string) {
        super(view, parent, vpid);
        this._moreLoading = this.find(".downMore");
    }
    protected _afterInstallTo() {
        this.view.parent().scroll((e) => {
            let div: HTMLElement = e.target as HTMLElement;
            let maxScroll = div.scrollHeight - div.offsetHeight;
            if (div.scrollTop > maxScroll - 5 && !this._loadMore) {
                this.loadMore();
            }
        })
    }
    private loadMore() {
        if (this._loadMore) { return; }
        this._loadMore = true;
        this._moreLoading.removeClass("hide");
        var next = () => {
            this._loadMore = false;
            this._moreLoading.addClass("hide");
        }
        var plist = model.globalData.project_list;
        var sort_val = plist[plist.length - 1].intm + "";
        api.GetDemandList({ "sort_val": sort_val }, (data) => {
            var newList = data;
            if(newList.length != 0){
                model.globalData.project_list.push(...newList);
                setTimeout(next, 3000);
            }else{
                this._moreLoading.addClass("hide");
            }
        }, () => {
            
            setTimeout(next, 3000);
        });
    }
    protected _afterUninstallTo() {
        this.view.parent().off('scroll');
    }
    init() {
        return tomato.getVPresenter<tomato.VPresenter>(funs.moduleToUrl('m/common/Header'), (Header) => {
            this._header = Header;
        })
    };
    getHeader() {
        return this._header.view;
    }
}
export = VPresenter;