<script src="`{VIEWSURL}`/global/common/config.js"></script>
<script>
    var apiServer = "`{APIURL}`";
    var ApiDomain = apiServer.substr(apiServer.indexOf("//") + 2);
    var demand_config = {
        typeOptions: {
            1: {
                name: '门头屏', id: '1', def: {
                    location: '3', color: '1', span: '3',
                    locationOptions: { 1: { name: '户外', id: '1' }, 2: { name: '室内', id: '2' }, 3: { name: '半户外', id: '3' } },
                    colorOptions: { 1: { name: '单色', id: '1' }, 2: { name: '双色', id: '2' }, 3: { name: '全彩', id: '3' } },
                    spanOptions: { 1: { name: 'P6', id: '1' }, 2: { name: 'P8', id: '2' }, 3: { name: 'P10', id: '3' }, 4: { name: '其他', id: '4' }, },
                }
            },
            2: {
                name: '户外广告屏', id: '2', def: {
                    location: '1', color: '3', span: '3',
                    locationOptions: { 1: { name: '户外', id: '1' } },
                    colorOptions: { 1: { name: '单色', id: '1' }, 2: { name: '双色', id: '2' }, 3: { name: '全彩', id: '3' } },
                    spanOptions: { 1: { name: 'P6', id: '1' }, 2: { name: 'P8', id: '2' }, 3: { name: 'P10', id: '3' }, 4: { name: '其他', id: '4' }, },
                }
            },
            3: {
                name: '信息告示屏', id: '3', def: {
                    location: '1', color: '1', span: '3',
                    locationOptions: { 1: { name: '户外', id: '1' }, 2: { name: '室内', id: '2' }, 3: { name: '半户外', id: '3' } },
                    colorOptions: { 1: { name: '单色', id: '1' }, 2: { name: '双色', id: '2' }, 3: { name: '全彩', id: '3' } },
                    spanOptions: { 1: { name: 'P6', id: '1' }, 2: { name: 'P8', id: '2' }, 3: { name: 'P10', id: '3' }, 4: { name: '其他', id: '4' }, },
                }
            },
            4: {
                name: '舞台用屏', id: '4', def: {
                    location: '2', color: '3', span: '2',
                    locationOptions: { 1: { name: '户外', id: '1' }, 2: { name: '室内', id: '2' }, 3: { name: '半户外', id: '3' } },
                    colorOptions: { 1: { name: '单色', id: '1' }, 2: { name: '双色', id: '2' }, 3: { name: '全彩', id: '3' } },
                    spanOptions: { 1: { name: 'P3', id: '1' }, 2: { name: 'P4', id: '2' }, 3: { name: 'P5', id: '3' }, 4: { name: '其他', id: '4' } }
                }
            },
            5: {
                name: '室内高清屏', id: '5', def: {
                    location: '2', color: '3', span: '2',
                    locationOptions: { 2: { name: '室内', id: '2' } },
                    colorOptions: { 1: { name: '单色', id: '1' }, 2: { name: '双色', id: '2' }, 3: { name: '全彩', id: '3' } },
                    spanOptions: { 1: { name: 'P1.25', id: '1' }, 2: { name: 'P2.0', id: '2' }, 3: { name: 'P2.5', id: '3' }, 4: { name: '其他', id: '4' } }
                }
            },
            0: {
                name: '其他', id: '0', def: {
                    location: '1', color: '3', span: '3',
                    locationOptions: { 1: { name: '户外', id: '1' }, 2: { name: '室内', id: '2' }, 3: { name: '半户外', id: '3' } },
                    colorOptions: { 1: { name: '单色', id: '1' }, 2: { name: '双色', id: '2' }, 3: { name: '全彩', id: '3' } },
                    spanOptions: { 1: { name: 'P6', id: '1' }, 2: { name: 'P8', id: '2' }, 3: { name: 'P10', id: '3' }, 4: { name: '其他', id: '4' } },
                }
            }
        },
        locationOptions: {
            1: { name: '户外', id: '1' },
            2: { name: '室内', id: '2' },
            3: { name: '半户外', id: '3' }
        },
        colorOptions: {
            1: { name: '单色', id: '1' },
            2: { name: '双色', id: '2' },
            3: { name: '全彩', id: '3' }
        },
        spanOptions: {
            1: { name: 'P6', id: '1' },
            2: { name: 'P8', id: '2' },
            3: { name: 'P10', id: '3' },
            4: { name: '其他', id: '4' },
        },
        faultOptions: {
            1: { name: '整屏或部分不亮', id: '1' },
            2: { name: '出现亮点暗点', id: '2' },
            3: { name: '有色彩问题', id: '3' },
            4: { name: '无法更换屏幕内容', id: '4' },
            5: { name: '屏幕移位', id: '5' },
            0: { name: '其他', id: '0' }
        },

    };
    var demand_cate = {
        "1": '安装',
        "2": '维修'
    }
    var supplier_vas =
        [ //仅工程商有
            // {
            //     type: 1,
            //     prov: "广东省",
            //     start_date: "2015-08-12",
            //     end_date: "2016-11-13",
            // },
            // {
            //     type: 1,
            //     prov: "四川省",
            //     start_date: "2015-08-12",
            //     end_date: "2017-11-13",
            // }
        ]
    var demand_empty = {
        "user": {
            id: '',
            nick: '',
            sex: 0,
            phone: ''
        },
        "id": "", //项目ID；
        "uid": "",
        "city": "",
        "prov": "",
        "cate": "1",
        "cate_name": "安装",
        "malf": "",
        "malf_name": "",
        "address": "",
        "type": 2,	//分类：0：其它；1：门头招牌；2：户外广告牌；3：信息告示牌；4：舞台用屏；5：室内高清屏；
        "size": "",
        "location": 1,  //1 => '户外', 2 => '室内', 3 => '半户外',
        "color": 1, //1：单色，2：双色，3：全彩
        "span": "",
        "budget": 0, //预算，0：表示议价；
        "budgetFormat": budget(0),
        "image": "",	//需求场地图片
        "status": "", //10进行中，60：交易结束
        "intm": 0,
        "uptm": 0,
        "note": "",
        "audio": "", //客服和客户之间的录音链接
        "bid_fee": 0, //抢单服务费
        "bid_cnt": 20,
        "supplier_partic_status": '0',
        "type_name": "户外广告屏",
        "location_name": '户外',
        "color_name": "单色",
        "span_id": 1,
        "supplier_list": []
    }
    $.ajax({
        url: '`{APIURL}`' + '/Ip/getIpInfo',
        type: 'POST',
        // dataType: JSON,
        xhrFields: {
            withCredentials: true
        },
        success: function (data, textStatus, jqXHR) {
            var result = {
                city: {
                    city_id: '北京市',
                    city_name: '北京市'
                },
                province: {
                    province_id: '北京市',
                    province_name: '北京市'
                }
            };
            if (data.status == 200) {
                // ip定位城市信息
                result = {
                    city: {
                        city_id: data.ip_info.city,
                        city_name: data.ip_info.city
                    },
                    province: {
                        province_id: data.ip_info.prov,
                        province_name: data.ip_info.prov
                    }
                }
            }
            getInit(result)
        },
        error: function (data) {
            fail(new tomato.PError('500', data.toString()));
        }
    });
    function getInit(ipInfo) {
        // 先查询是否有选择的城市的cookie
        var provData = { prov: ipInfo.province.province_name };
        var selProv = getCookie(ApiDomain + '$selected_prov');
        // cookie中是否存在选择的城市
        var cookie_slected_prov = '';
        if (selProv) {
            provData = {
                prov: selProv,
            };
            cookie_slected_prov = {
                province_id: selProv,
                province_name: selProv
            }
        }
        $.ajax({
            url: '`{APIURL}`' + '/Index/getInitData',
            type: 'POST',
            // dataType: JSON,
            data: provData,
            xhrFields: {
                withCredentials: true
            },
            success: function (data, textStatus, jqXHR) {
                var demand_id = qs("demand");
                var uid = qs("uid");
                var sortConfig = {
                    sort: "id",
                    order: "desc",
                    cnt: 20,
                };
                provData = $.extend(provData,sortConfig);
                GetDemandList(provData, function (prolist) {
                    getDemandInfo(demand_id, function (demandInfo) {
                        GetList4User(uid, function (userProList) {
                            json = data;
                            if (json.status == 200) {
                                json.selected_province = {
                                    province_id: ipInfo.province.province_name,
                                    province_name: ipInfo.province.province_name
                                }
                                // 如果cookie中存在已选择的城市
                                if (cookie_slected_prov) {
                                    json.selected_province = cookie_slected_prov;
                                }
                                // 用户信息
                                json.user = mappingUser(json.user);
                                // 参与的项目列表
                                json.partic_demand_list = json.partic_demand_list.map(function (item) {
                                    return mappingDemand(item);
                                });
                                // 已开通的增值服务列表
                                json.supplier_vas = json.sms_vas_list;
                                //自己的项目列表
                                if (json.my_demand_list) {
                                    var num = json.my_demand_list.length;
                                    for (var i = 0; i < num; i++) {
                                        json.my_demand_list[i] = mappingDemand(json.my_demand_list[i]);
                                    }
                                } else {
                                    json.my_demand_list = [];
                                }

                                result = json;
                            } else {
                                json.my_demand_list = [];
                                result = json;
                            }
                            result.current_demand = demand_id ? demandInfo : userProList[0];
                            result.ipInfo = ipInfo;
                            result.prolist = prolist;
                            result.currUserDemandList = userProList;
                            concatData(result)
                        })
                    }, function (fail) {

                    })
                })
            }
        })
    }
    function getDemandInfo(demand_id, succ, fail) {
        if (!demand_id) {
            var demandInfo = demand_empty;
            succ && succ(demand_empty);
        } else {
            $.ajax({
                url: '`{APIURL}`' + '/Demand/getInfo',
                type: 'POST',
                // dataType: JSON,
                data: { "id": demand_id },
                xhrFields: {
                    withCredentials: true
                },
                success: function (data, textStatus, jqXHR) {
                    json = data;
                    if (json.status == 200 && json.info) {
                        result = mappingDemand(json.info);
                    } else {
                        result = demand_empty;
                    }
                    succ && succ(result);
                },
                error: function () {

                }
            })
        }
    }
    function GetList4User(uid, succ, fail) {
        if (!uid) {
            var list = [demand_empty];
            succ && succ(list);
        } else {
            $.ajax({
                url: '`{APIURL}`' + '/Supplier/Demand/getList4User',
                type: 'POST',
                // dataType: JSON,
                data: { "uid": uid },
                xhrFields: {
                    withCredentials: true
                },
                success: function (data, textStatus, jqXHR) {
                    json = data;
                    if (json.status == 200 && json.list) {
                        result = json.list.map(function (item) {
                            return mappingDemand((item));
                        })
                    } else {
                        result = [demand_empty];
                    }
                    succ && succ(result);
                },
                error: function () {

                }
            })
        }
    }
    function GetDemandList(provData, succ, fail) {
        $.ajax({
            url: '`{APIURL}`' + '/Demand/getDemandList',
            type: 'POST',
            // dataType: JSON,
            data: provData,
            xhrFields: {
                withCredentials: true
            },
            success: function (data, textStatus, jqXHR) {
                json = data;
                if (json.status == 200 && json.list) {
                    result = json.list.map(function (item) {
                        return mappingDemand(item);
                    })
                } else {
                    result = [];
                }
                succ && succ(result);
            },
            error: function () {

            }
        })
    }
    function concatData(json) {
        var result = {
            user: json.user,
            city: json.ipInfo.city,
            province: json.ipInfo.province,
            selected_city: json.ipInfo.city,
            selected_province: json.selected_province,
            demand: json.my_demand_list,
            current_demand: json.current_demand, //当前打开的项目详情项目
            demand_config: demand_config,
            supplier_vas: json.supplier_vas,
            unread_num: {
                group_unread: '0',
                private_unread: '0'
            },
            project_list: json.prolist,
            joined_list: json.partic_demand_list,
            currUserDemandList: json.currUserDemandList,
            friend_list: mappingFriends(json.partic_demand_list),
            currPage: 'Index'
        };
        globalsConfig("`{VIEWSURL}`", "`{VIEWSURL}`/m/common/CommonPage.js", result);
    }
    function budget(money) {
        function std_money_format_in_th(money) {
            money = money + "";
            var intLen = money.split('.')[0].length;
            if (intLen > 4) {
                return { "budget": std_num_format(money / 10000), "unit": "万" }
            } else if (intLen > 3) {
                return { "budget": std_num_format(money / 1000), "unit": "千" }
            } else if (intLen > 2) {
                return { "budget": std_num_format(money / 100), "unit": "百" }
            } else {
                return { "budget": money, "unit": "" };
            }
        }
        function std_num_format(num) {
            num += '';
            var parts = num.split('.');
            var float_cnt = 0;
            if (parts.length > 1) {
                var deci = parts[1];
                float_cnt = (parseInt(deci) > 0) ? deci.length : 0;
            }

            var pureRes = number_format(num, Math.min(2, float_cnt));
            var ptIndex = pureRes.indexOf('.');
            if (ptIndex === -1) {
                // 整数
                return pureRes;
            } else {
                // 下面这些处理，是为了死也要保证小数点后末尾不能为0。即使这是不科学的四舍五入，产品及相关人员也认为这比科学要更好。好吧，我妥协
                var num = parseInt(pureRes.substr(ptIndex + 1));
                if (0 === num) {
                    // 123.00型
                    return pureRes.substr(0, ptIndex);
                } else if (0 === num % 10) {
                    // 123.40型
                    return pureRes.substr(0, pureRes.length - 1);
                } else {
                    return pureRes;
                }
            }
        }
        function number_format(number, decimals, decPoint, thousandsSep) { // eslint-disable-line camelcase

            number = (number + '').replace(/[^0-9+\-Ee.]/g, '')
            var n = !isFinite(+number) ? 0 : +number
            var prec = !isFinite(+decimals) ? 0 : Math.abs(decimals)
            var sep = (typeof thousandsSep === 'undefined') ? ',' : thousandsSep
            var dec = (typeof decPoint === 'undefined') ? '.' : decPoint
            var s = '';
            var toFixedFix = function (n, prec) {
                var k = Math.pow(10, prec)
                return '' + (Math.round(n * k) / k)
                    .toFixed(prec)
            }
            // @todo: for IE parseFloat(0.55).toFixed(0) = 0;
            s = (prec ? toFixedFix(n, prec) : '' + Math.round(n)).split('.')
            if (s[0].length > 3) {
                s[0] = s[0].replace(/\B(?=(?:\d{3})+(?!\d))/g, sep)
            }
            if ((s[1] || '').length < prec) {
                s[1] = s[1] || ''
                s[1] += new Array(prec - s[1].length + 1).join('0')
            }

            return s.join(dec)
        }
        var data = std_money_format_in_th(money);
        if (data.budget == "" || data.budget == 0) {
            data.budget = "";
        }
        return data;
    }
    function mappingUser(json) {
        json.user_type = parseInt(json.type);
        json.user_id = json.id;
        json.sex = json.gender || 1;
        json.nick = json.nickname || '';
        json.address = json.addr || '';
        json.balance = json.bal || '';
        json.position = json.pos || '';
        json.company_name = json.com || '';
        json.activated = json.active || '';
        json.phone = json.mobile || '';
        delete json.type;
        delete json.id;
        delete json.gender;
        delete json.pos;
        delete json.com;
        delete json.addr;
        delete json.bal;
        delete json.nickname;
        delete json.active;
        return json;
    }
    function mappingDemand(json) {
        var demand = Object.assign({}, json, json.demand);
        delete demand.demand;
        if (!demand.cate) { demand.cate = "1" };
        if (demand.surr == 0) { demand.surr = "1" };
        if (!demand.color || demand.color == 0) { demand.color = "1" };
        demand.cate_name = demand_cate[demand.cate];
        demand.type_name = demand_config.typeOptions[demand.type].name;
        demand.location_name = demand_config.locationOptions[demand.surr].name;
        demand.color_name = demand_config.colorOptions[demand.color].name;
        demand.malf_name = demand_config.faultOptions[demand.malf].name;
        demand.location = demand.surr;
        demand.image = demand.img;
        demand.note = demand.remark;
        demand.intm = parseInt(demand.created_at);
        demand.uptm = parseInt(demand.updated_at);
        demand.address = demand.addr;
        demand.supplier_list = demand.partic_supplier_list;
        demand.user.sex = demand.user.gender;
        demand.user.nick = demand.user.nickname;
        demand.supplier_list.forEach(function (item) {
            item.company_name = item.com;
            item.nick = item.nickname;
            item.unread = '';
        })
        demand.im_unread = {
            group: 0,
            friends: 0
        };
        demand.budgetFormat = budget(demand.budget);
        delete demand.surr;
        delete demand.img;
        delete demand.addr;
        delete demand.remark;
        delete demand.created_at;
        delete demand.updated_at;
        delete demand.partic_supplier_list;
        delete demand.gender;
        delete demand.user.mobile;
        delete demand.user.nickname;
        delete demand.user.gender;
        return demand;
    }
    function mappingFriends(list) {
        var friend_list = [];
        var friends = [{
            id: '3',
            nick: '万屏汇小秘书',
            phone: '',
            sex: '0',
            im_unread: 0,
            lastMsg: ''
        }];
        list.forEach(function (demand) {
            friend_list[demand.user.id] = demand.user;
            friend_list[demand.user.id].im_unread = 0;
            friend_list[demand.user.id].lastMsg = '';
        }, this);
        for (var key in friend_list) {
            if (key && friend_list[key] != [] && friend_list[key].length != 0) {
                friends.push(friend_list[key]);
            }
        }
        return friends
    }
    function qs(name) {
        var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
    }
    function getCookie(key) {
        var arr, reg = new RegExp("(^| )" + key + "=([^;]*)(;|$)");
        if (arr = document.cookie.match(reg)) {
            return window.unescape(arr[2]);
        } else {
            return null;
        }
    }

</script>
<div id="Track" class="hide">
    <iframe id="TrackFrame" src=""></iframe>
    <iframe id="SubTrackFrame" src=""></iframe>
</div>