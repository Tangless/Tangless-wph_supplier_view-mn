import * as tomato from "@po-to/tomato";
import * as tdom from "@po-to/tomato-jquery";
import * as project from "views/global/common/Project";
import * as funs from "views/global/common/Funs";
import * as model from "views/global/common/Model";
import * as api from "views/global/common/API";
import * as Vue from 'vue';
import ValueAddService = require('views/m/user/ValueAddService');


class VPresenter extends project.VPresenter {
    private _fromPage: string;
    constructor(view: tomato.VPView, parent?: tomato.VPresenter, vpid?: string) {
        super(view, parent, vpid);
        this._fromPage = 'Index';
        this._watchEvent();
        var v_currCity = this.find('#ProvinceSelector-current')[0];
        var curr_city = model.globalData.province;
        new Vue({
            el: v_currCity,
            data: curr_city
        })
    }
    setProv(formPage: string) {
        this._fromPage = formPage;
    }
    _evt_selected(data: any, target: HTMLElement, hit: HTMLElement) {
        let city = hit.getAttribute("data-province");
        if (city) {
            this.select(city, city);
        }
    }
    select(text: string, id: string) {
        if (this._fromPage == 'Index') {

            model.globalData.selected_province.province_id = id;
            model.globalData.selected_province.province_name = text;
            // 如果当前选择城市和ip定位城市不一致，则保存城市选择；
            if (model.globalData.selected_province.province_id != model.globalData.province.province_id) {
                funs.setCookie('selected_prov', id);
            }else{
                funs.setCookie('selected_prov','');
            }
            var sort_val = new Date().getTime() + '';
            api.GetDemandList({ "sort_val": sort_val }, (data) => {
                var newList = data;
                var old_list = model.globalData.project_list
                model.globalData.project_list.splice(0, old_list.length, ...newList);
            }, () => {
                funs.tip('请求失败', '获取选择的省份项目列表失败，请刷新重试', 'fail');
            });
        } else if (this._fromPage == 'SMS') {
            tomato.getVPresenter<ValueAddService>(funs.moduleToUrl('m/user/ValueAddService'), (ValueAddService) => {
                ValueAddService.setProv(text);
            });
            this._fromPage = 'Index';
        }
        funs.viewHistory.go(-1);
    }
}
export = VPresenter;